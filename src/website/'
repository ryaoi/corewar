from django.shortcuts import render, redirect
from django.http import HttpResponse
from django.template import loader, Context
from . import libcore
from visu.models import logs, memory

# Create your views here.
game = libcore.CorewarGame()

def play_game():
    game.champions.append("../../resources/test_champ1.cor")
    game.champions.append("../../resources/test_champ2.cor")
    game.prepare()
  #  while game.update() ==  True:
  #      mems.append(game.mem_dump().hex())
   # active_logs = game.logs[0] + game.logs[1]
   # active_logs.sort(key=lambda x: x[1])

def index(request):
    template = loader.get_template('visu/index.html')
    context = {
            } 
    return HttpResponse(template.render(context, request))

def play_cycle(request, cycle):
    template = loader.get_template('visu/play.html')
    for x in game.logs:
        x.clear()
    game.update()
    mem_dump = game.mem_dump().hex()
    i = 0
    mem = ""
    while (i < 64):
        mem = mem + mem_dump[i* 128:i * 128 + 128]
        mem = mem + " "
        i += 1
    active_logs = game.logs[0] + game.logs[1]
    active_logs.sort(key=lambda x: x[1])
    context = {
            "logs" : active_logs,
            "mem" : mem,
            #"screen": mems[cycle],
            "cycle": cycle
            } 
    return HttpResponse(template.render(context, request))

def show_cycle(request, cycle):
    template = loader.get_template('visu/show.html')
    context = {
            "cycle" : cycle,
            }
    return HttpResponse(template.render(context, request))


def play(request):
    play_game()
    return redirect('play_cycle', cycle='1')
